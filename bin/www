#!/usr/bin/env node
var debug = require('debug')('enq');
show_viewer = true;
app = require('../app');
var exec = require('child_process').exec;
var fork = require('child_process').fork;
var cluster = require('cluster');
var PaydeskBus = require('../util/paydesk_bus');

app.set('port', 3232);
	// if (cluster.isMaster) {


		var child = exec('node ./util/service_broadcaster.js '+ app.get('port'));
		child.stdout.on('data', function(data) { console.log(data); });



		// Count the machine's CPUs
	 // 	var cpuCount = require('os').cpus().length;

		// // Create a worker for each CPU
		// for (var i = 0; i < cpuCount; i += 1) {
		// 	cluster.fork();
		// }

	// Code to run if we're in a worker process
	// } else {
var server = app.listen(app.get('port'), function() {
	console.log('Express server listening on port ' + server.address().port);
});

app.set('io',require('socket.io')(server));

app.get('io').on('connection', function(ws) {
  PaydeskBus.on('client_response', function(res) {
    ws.emit('client_response', res);
  });
});

// var viewer = { send: function() {} };

// if (process.argv[2] == "--viewer") {
// 	viewer = fork('./util/viewer.js');
// }

// app.set('viewer',  viewer )

	// }




