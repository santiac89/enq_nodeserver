<% layout('layout') -%>
<!-- TODO Agregar validaciones a los campos, chequear cajas duplicadas o agregadas a otros grupos, permitir editar grupos -->

<div class="container-fluid" ng-app="Admin" ng-controller="groupsController" ng-init="refresh()">

	<div class="row">
		<h1>Administracion de grupos</h1>
	</div>

	<div class="row">
		<div class="col-md-3">
			<div class="list-group groups">
				<a href="#" ng-repeat="group in groups" class="list-group-item group" data-id="{{group._id}}" ng-click="load(group._id)">{{group.name}} - Timeout: {{group.timeout}}
					<span class="badge" ng-click="delete(group)"><span class="glyphicon glyphicon-remove" ></span></span>
					
				</a>
				<a href="#" class="list-group-item group" data-toggle="modal" data-target="#groupEditModal"><span class="glyphicon glyphicon-plus" ></span> Nuevo grupo</a>
			</div>
		</div>
		<div class="col-md-6">
			<div class="list-group paydesks">
				<a href="#" class="list-group-item paydesk empty" ng-hide="selectedgroup.paydesks.length">No hay cajas asignadas a este grupo.</a>
				<a href="#" class="list-group-item paydesk" ng-repeat="paydesk in selectedgroup.paydesks">{{paydesk}} <span class="badge"> <span class="glyphicon glyphicon-remove" ng-click="removePaydesk(paydesk)"></span></span></a>
				<a href="#" class="list-group-item paydesk new" data-toggle="modal" data-target="#newPaydeskModal"><span class="glyphicon glyphicon-plus" ></span> Nueva caja </a>
			</div>
		</div>
	</div>

	<div class="modal fade" id="groupEditModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" ng-hide="new">Editar grupo</h4>
					<h4 class="modal-title" ng-show="new">Nuevo grupo</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
					    <label for="inputName">Nombre</label>
					    <input type="text" class="form-control" id="inputName" placeholder="Nombre" ng-model="newgroup.name">
					</div>

				    <div class="form-group">
					    <label for="inputTimeout">Timeout</label>
					    <input type="text" class="form-control" id="inputTimeout" placeholder="Timeout" ng-model="newgroup.timeout">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
					<button type="button" class="btn btn-primary" data-dismiss="modal" ng-click="save()">Guardar</button>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->

	<div class="modal fade" id="newPaydeskModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title">Agregar caja a "{{selectedgroup.name}}"</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
					    <label for="inputName">Numero de caja</label>
					    <input type="text" class="form-control" id="inputName" placeholder="Numero de caja" ng-model="newpaydesk">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button"  class="btn btn-default" data-dismiss="modal">Cancelar</button>
					<button type="button"  class="btn btn-primary" data-dismiss="modal" ng-click="addPaydesk()">Guardar</button>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->


</div>




<script>

	var app = angular.module('Admin', []);
	app.controller('groupsController', function($scope,$http) {
	    
	    $scope.newgroup = {};
	    $scope.selectedgroup = {};
	    $scope.newpaydesk = undefined;

	    $scope.refresh = function() {
	    	$http.get("/groups").success(function(groups) { 
	    		$scope.groups = groups; 
	    	});
	    }

	    $scope.save = function() {
	    	$http.post("/groups",$scope.newgroup).success(function(newGroup) {
	    		$scope.reset();
	    		$scope.refresh();
	    	});
	    }

     	$scope.delete = function(group) {
	    	if (confirm("Esta seguro que desea eliminar \""+group.name+"\" ?"))	{
	    		$http.delete("/groups/"+group._id).success(function(res) {
	    			$scope.refresh();
	    		});	
	    	}
	    }

	    $scope.reset = function() {
	    	$scope.newgroup = {};
	    }

	    $scope.load = function(id) {
	    	$http.get("/groups/"+id).success(function(group) { 
	    		$("a.list-group-item.group").removeClass("active");
				$("a.list-group-item.group[data-id="+group._id+"]").addClass("active");
	    		$scope.selectedgroup = group;
	       	});
	    }

	    $scope.addPaydesk = function() {
	    	$scope.selectedgroup.paydesks.push($scope.newpaydesk);
	    	$http.put("/groups/"+$scope.selectedgroup._id,$scope.selectedgroup).success(function(group) { 
	    		$scope.load($scope.selectedgroup._id);
	    		$scope.newpaydesk = undefined;
	    	});
	    }

	    $scope.edit = function(group)
	    {
	    	$scope.new = false;
	    }

        $scope.removePaydesk = function(number) {
	    	$scope.selectedgroup.paydesks = $scope.selectedgroup.paydesks.filter(function(el) { return el != number } );
	    	$http.put("/groups/"+$scope.selectedgroup._id,$scope.selectedgroup).success(function(group) { 
	    		$scope.load($scope.selectedgroup._id);
	    	});
	    }
	});
	
</script>


