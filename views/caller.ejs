<% layout('./layouts/layout') -%>
<!-- TODO Agregar validaciones a los campos, chequear cajas duplicadas o agregadas a otros grupos, permitir editar grupos -->

<div class="container-fluid" ng-app="Caller" ng-controller="callerController" ng-init="init()">

  <div class="row paydesk_header">
    <h1>Caja  <span class="green" style="font-size: 35px; "><%= paydesk.number %></span></h1>
    <h3>Tipo de atención: <span class="green" style="font-size: 25px; "><%= group.name %></span></h3>
  </div>


  <div class="row">
    <div class="col-md-6">
        <h3>Cliente en atención</h3>
    </div>
    <div class="col-md-6">
        <h3>Cliente llamado</h3>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
        <h4>Número:</h4>
    </div>
    <div class="col-md-3">
        <h4 class="bold green" ng-bind="current_client.number"></h4>
    </div>
    <div class="col-md-3">
        <h4>Número:</h4>
    </div>
    <div class="col-md-3">
        <h4 class="bold green" ng-bind="called_client.number"></h4>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
        <h4>Horario de ingreso:</h4>
    </div>
    <div class="col-md-3">
        <h4 class="bold green" ng-bind="formatTimestamp(current_client.enqueue_time)"></h4>
    </div>
    <div class="col-md-3">
        <h4>Horario de ingreso:</h4>
    </div>
    <div class="col-md-3">
        <h4 class="bold green" ng-bind="formatTimestamp(called_client.enqueue_time)"></h4>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
        <h4>Respuesta:</h4>
    </div>
    <div class="col-md-3">
        <h4 class="bold green" ng-bind="current_client.response"></h4>
    </div>
    <div class="col-md-3">
        <h4>Respuesta:</h4>
    </div>
    <div class="col-md-3">
        <h4 class="bold green" ng-bind="called_client.response"></h4>
    </div>
  </div>

  <div class="row" style="text-align: center; margin-top: 15px;">
    <a href="#"  id="call_button" class="btn btn-success" ng-click="callNext()">Llamar próximo</a>
  </div>

</div>

<script type='text/javascript' src='/javascripts/socket.io.js'></script>
<script>



  var app = angular.module('Caller', []);
  app.controller('callerController', function($scope,$http) {

      $scope.current_client = {};
      $scope.called_client = {};
      $scope.paydesk = {};
      $scope.socket = null;
      $scope.call_interval_id = 0;
      $scope.client_interval_id = 0;

      $scope.init = function() {

        $scope.reloadStatus();

        $scope.socket = io('http://'+window.location.host);

        $scope.socket.on('connect', function() {
          $scope.socket.emit('paydesk_connection', { paydesk_id: "<%= paydesk._id %>" });
        });

        $scope.socket.on('client_response', function (data) {

          if (data.paydesk_number != <%= paydesk.number %>) return;

          clearInterval($scope.call_interval_id);

          $scope.current_client = $scope.called_client;
          $scope.called_client = {};

          switch (data.message) {

              case 'confirmed':
                $scope.current_client.response = "Confirmado";
                $scope.startArrivalTimeout(<%= group.paydesk_arrival_timeout %>);
              break;

              case 'error':
                $scope.current_client.response = "ERROR";
                $("#call_button").removeAttr("disabled");
              break;

              case 'cancelled':
                $scope.current_client.response = "Cancelado";
                $("#call_button").removeAttr("disabled");
              break;

              default:
                $scope.current_client.response = "Reencolado";
                $("#call_button").removeAttr("disabled");
              break;
           }

           $scope.$apply();

        });

      }

      $scope.reloadStatus = function() {

        $scope.paydesk = JSON.parse("<%= JSON.stringify(paydesk) %>".replace(/&quot;/g, '"'));
        $scope.current_client =  JSON.parse("<%= JSON.stringify(current_client) %>".replace(/&quot;/g, '"'));
        $scope.called_client =  JSON.parse("<%= JSON.stringify(called_client) %>".replace(/&quot;/g, '"'));

        if ($scope.current_client.remain_to_arrive > 0) {
           $("#call_button").attr("disabled","disabled");
           $scope.startArrivalTimeout($scope.current_client.remain_to_arrive);
        }

        if ($scope.called_client.remain_to_response > 0) {
           $("#call_button").attr("disabled","disabled");
           $scope.startCallResponseTimeout($scope.called_client.remain_to_response);
        }

      }

      $scope.callNext = function() {

        if ($("#call_button").attr("disabled") == undefined) {
          $http.get("/caller/<%= paydesk._id %>/clients/next").success(function(next_client) {

            $("#call_button").attr("disabled","disabled");

            $scope.called_client = next_client;
            $scope.startCallResponseTimeout(<%= call_timeout %>);


          }).error(function() {
              $scope.called_client.number = "No hay mas clientes.";
          });
        }
      }

      $scope.formatTimestamp = function(timestamp) {
        var date = new Date(timestamp);
        return timestamp == undefined ? '' : date.getHours()+':'+date.getMinutes();
      }

      $scope.startCallResponseTimeout = function(seconds) {
        var count =  seconds;
          $scope.call_interval_id = setInterval(function() {
            $scope.called_client.response = "Esperando respuesta... " + count--;
            $scope.$apply();

            if (count == 0) {
              clearInterval($scope.call_interval_id);
            }

          }, 1000);
      }

      $scope.startArrivalTimeout = function(seconds, callback) {
        var count = seconds;
          $scope.confirmed_interval_id = setInterval(function() {

            $("#call_button").html("Esperando por el cliente... " + count--);

            if (count == 0) {
              clearInterval($scope.confirmed_interval_id);
              $("#call_button").html("Llamar próximo");
              $("#call_button").removeAttr("disabled");
            }

          }, 1000);
      }

  });

</script>


